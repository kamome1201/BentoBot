<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ãŠå¼å½“æ³¨æ–‡ãƒ•ã‚©ãƒ¼ãƒ </title>
  <style>
    body {
      font-family: sans-serif;
      padding: 2em;
      max-width: 700px;
      margin: auto;
    }
    h1 {
      font-size: 1.5em;
      margin-bottom: 1em;
    }
    .menu-item {
      margin-bottom: 0.5em;
    }
    label {
      display: block;
      margin-top: 1em;
    }
    input[type="number"] {
      width: 50px;
    }
    .note {
      font-size: 0.9em;
      color: gray;
    }
  </style>
</head>
<body>
  <h1>ğŸœ ãŠå¼å½“æ³¨æ–‡ãƒ•ã‚©ãƒ¼ãƒ </h1>
  <form id="order-form">
    <div id="menu-container">
      <p>ãƒ¡ãƒ‹ãƒ¥ãƒ¼èª­ã¿è¾¼ã¿ä¸­...</p>
    </div>
    <hr>
    <label>æ³¨æ–‡æ—¥:
      <select id="order-date"></select>
    </label>
    <label>ãŠåå‰: <input type="text" id="user-name" required></label>
    <label>GitHub Personal Access Token: <input type="password" id="token" required></label>
    <button type="submit">æ³¨æ–‡ã‚’GitHub Issueã«é€ä¿¡</button>
    <p class="note">
      â€» Tokenã¯æœ¬ãƒšãƒ¼ã‚¸ä¸Šã«ã¯ä¿å­˜ã•ã‚Œã¾ã›ã‚“ã€‚
      åˆ©ç”¨å¾Œã¯å‰Šé™¤ã™ã‚‹ã“ã¨ã‚’ãŠå‹§ã‚ã—ã¾ã™ã€‚
    </p>
  </form>

  <script>
    const repo = "kamome1201/BentoBot";
    const apiUrl = `https://api.github.com/repos/${repo}/issues`;

    // æ³¨æ–‡æ—¥ select ã®ç”Ÿæˆ
    const dateSelect = document.getElementById("order-date");
    const today = new Date();
    const dateSelect = document.getElementById("order-date");
    const today = new Date();
    
    Promise.all([
      fetch("calendar_status.json").then(res => res.json()),
    ])
    .then(([calendarStatus]) => {
      for (let i = 0; i < 30; i++) {
        const d = new Date(today);
        d.setDate(today.getDate() + i);
        const yyyy = d.getFullYear();
        const mm = String(d.getMonth() + 1).padStart(2, '0');
        const dd = String(d.getDate()).padStart(2, '0');
        const wday = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'][d.getDay()];
        const val = `${yyyy}-${mm}-${dd}`;
        const label = `${mm}/${dd} (${wday})`;
    
        const status = calendarStatus[val] || "normal";
        let emoji = "";
        if (status === "holiday") emoji = "ï¼ˆä¼‘æ¥­æ—¥ï¼‰";
        if (status === "premium") emoji = " ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ãƒ‡ãƒ¼ğŸ±";
        if (status === "special") emoji = " ã‚¹ãƒšã‚·ãƒ£ãƒ«ãƒ‡ãƒ¼ğŸ¯";
    
        const opt = document.createElement("option");
        opt.value = val;
        opt.textContent = label + emoji;
        if (status === "holiday") opt.disabled = true;
        dateSelect.appendChild(opt);
      }
    });

    // ãƒ¡ãƒ‹ãƒ¥ãƒ¼èª­ã¿è¾¼ã¿
    fetch("menu_today.json")
      .then(res => res.json())
      .then(data => {
        const menu = data.filter(item => item.name && item.price);
        const container = document.getElementById("menu-container");
        container.innerHTML = "";
        menu.forEach((item, index) => {
          const div = document.createElement("div");
          div.className = "menu-item";
          div.innerHTML = `
            <label>
              <input type="checkbox" name="menu" value="${item.name}" data-price="${item.price}">
              ${item.name}ï¼ˆ${item.price}ï¼‰
              æ•°é‡: <input type="number" name="count-${index}" value="1" min="1">
            </label>
          `;
          container.appendChild(div);
        });
      });

    document.getElementById("order-form").addEventListener("submit", async (e) => {
      e.preventDefault();
      const name = document.getElementById("user-name").value;
      const token = document.getElementById("token").value;
      const orderDate = document.getElementById("order-date").value;
      const checked = Array.from(document.querySelectorAll("input[name='menu']:checked"));

      if (!checked.length) {
        alert("æ³¨æ–‡å•†å“ã‚’é¸æŠã—ã¦ãã ã•ã„");
        return;
      }

      let body = `ã€æ³¨æ–‡è€…ã€‘ ${name}\nã€æ³¨æ–‡æ—¥ã€‘ ${orderDate}\n\nã€æ³¨æ–‡å†…å®¹ã€‘\n`;
      checked.forEach((item, i) => {
        const quantity = document.querySelector(`input[name='count-${i}']`).value || 1;
        body += `- ${item.value} Ã— ${quantity}\n`;
      });

      const res = await fetch(apiUrl, {
        method: "POST",
        headers: {
          "Authorization": `token ${token}`,
          "Accept": "application/vnd.github+json"
        },
        body: JSON.stringify({
          title: `ãŠå¼å½“æ³¨æ–‡ - ${name}`,
          body,
          labels: ["bento-order"]
        })
      });

      if (res.ok) {
        alert("æ³¨æ–‡ã‚’å—ä»˜ã‘ã¾ã—ãŸï¼GitHub Issues ã‚’ã”ç¢ºèªãã ã•ã„");
        document.getElementById("order-form").reset();
      } else {
        alert("æ³¨æ–‡å¤±æ•—ã€‚TokenãŒä¸æ­£ã‹ã€ã‚‚ã—ãã¯åˆ©ç”¨æ¨©ãŒè¶³ã‚Šãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™");
      }
    });
  </script>
</body>
</html>
